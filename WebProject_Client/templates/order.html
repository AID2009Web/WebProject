<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>提交订单</title>
    <!-- 引入外部css文件 -->
    <link rel="stylesheet" href="../static/css/common.css">
    <link rel="stylesheet" href="../static/css/order.css">
    <!-- 引入外部js文件 -->
    <script src="../static/js/jquery.min.js"></script>
    <!-- 引入外部js文件, 功能：地址三级联动下拉选择 -->
    <script src="../static/js/distpicker.min.js"></script>
    <!-- 自定js文件 -->
    <script src="../static/js/init.js"></script>
    <script src="../static/js/nav.js"></script>
    <script src="../static/js/footer.js"></script>
    <script src="../static/js/order.js"></script>
    <script src="../static/js/address.js"></script>
</head>

<body>
<header>

</header>
<main>

    <div class="main-body">
        <form id="checkout-form" action="#" method="POST">
            <div class="main-body-top">
                <input type="hidden" name="Checkout[addressState]" id="addrState" value="0">
                <!-- 收货地址开始 -->
                <div class="mbt-box">
                    <div class="mbt-box-title">
                        <h2 class="title">收货地址</h2>
                    </div>
                    <div class="mbt-box-body">
                        <div class="mbt-addr-body-list fixWindow">
                            <dl class="addr-item selected">
                                <dt>
                                    <strong class="addr-name">王小二</strong>
                                    <span class="addr-tag">家</span>
                                </dt>
                                <dd>
                                    <p class="addr-tel">18800001111</p>
                                    <p class="addr-region">深圳 龙华 民治</p>
                                    <p class="addr-street">嘉熙业广场01号001</p>
                                    <span class="addr-edit">编辑</span>
                                </dd>
                                <dd style="display: none">
                                    <input type="radio" name="checkout[address]" class="address-id" value="123456">
                                </dd>
                            </dl>
                            <div class="addr-item addr-add">
                                    <span>
                                        <img src="../static/images/add.png">
                                    </span>
                                使用新地址
                            </div>
                        </div>
                        <!--点击弹出新增/收货地址界面start-->
                        <div class="xm-edit-addr-box" id="J_editAddrBox">
                            <div class="bd">
                                <div class="item">
                                    <label>收货人姓名<span>*</span></label>
                                    <input type="text" name="userAddress[consignee]" id="Consignee" class="input"
                                           placeholder="收货人姓名" maxlength="15" autocomplete='off'>
                                    <p class="tip-msg tipMsg"></p>
                                </div>
                                <div class="item">
                                    <label>联系电话<span>*</span></label>
                                    <input type="text" name="userAddress[tel]" class="input" id="Telephone"
                                           placeholder="11位手机号" autocomplete='off'>
                                    <p class="tel-modify-tip" id="telModifyTip"></p>
                                    <p class="tip-msg tipMsg"></p>
                                </div>
                                <div class="item" id="addr_select">
                                    <label>地址<span>*</span></label>
                                    <select name="userAddress[province]" id="Provinces" class="select-1">
                                    </select>
                                    <select name="userAddress[city]" id="Citys" class="select-2">
                                    </select>
                                    <select name="userAddress[county]" id="Countys" class="select-3">
                                    </select>
                                    <textarea name="userAddress[street]" class="input-area" id="Street"
                                              placeholder="路名或街道地址，门牌号"></textarea>
                                    <p class="tip-msg tipMsg"></p>
                                </div>
                                <div class="item">
                                    <label>邮政编码<span>*</span></label>
                                    <input type="text" name="userAddress[zipcode]" id="Zipcode" class="input"
                                           placeholder="邮政编码" autocomplete='off'>
                                    <p class="zipcode-tip" id="zipcodeTip"></p>
                                    <p class="tip-msg tipMsg"></p>
                                </div>
                                <div class="item">
                                    <label>地址标签<span>*</span></label>
                                    <input type="text" name="userAddress[tag]" id="Tag" class="input"
                                           placeholder='地址标签：如"家"、"公司"。限5个字内'>
                                    <p class="tip-msg tipMsg"></p>
                                </div>
                            </div>
                            <div class="ft fixWindow">
                                <button type="button" class="btn btn-gray btn-small" id="J_editAddrCancel">取消
                                </button>
                                <button type="button" class="btn btn-red btn-small" id="J_editAddrOk">保存</button>
                            </div>
                        </div>
                        <!--点击弹出新增/收货地址界面end-->
                    </div>
                </div>
                <!-- 收货地址结束 -->
                <!-- 支付方式 -->
                <div class="mbt-box">
                    <div class="mbt-box-title">
                        <h2 class="title">支付方式</h2>
                    </div>
                    <div class="mbt-box-body">
                        <ul id="payment-select" class="checkout-option-list fixWindow">
                            <li class="item-pay selected">
                                <input type="radio" name="Checkout[pay_id]" checked="checked" value="1">
                                <p>
                                    在线支付
                                    <span></span>
                                </p>
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- 支付方式结束 -->
                <!-- 配送方式 -->
                <div class="mbt-box">
                    <div class="mbt-box-title">
                        <h2 class="title">配送方式</h2>
                    </div>
                    <div class="mbt-box-body">
                        <ul id="shipment-select" class="checkout-option-list fixWindow">
                            <li class="item-shipment selected">
                                <input type="radio" name="Checkout[shipment_id]" checked="checked" value="1">
                                <p>
                                    商家配送（免运费）
                                    <span></span>
                                </p>
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- 配送方式结束 -->
                <!-- 送货时间 -->
                <div class="mbt-box">
                    <div class="mbt-box-title">
                        <h2 class="title">送货时间</h2>
                    </div>
                    <div class="mbt-box-body">
                        <ul id="shipment-select" class="checkout-option-list fixWindow">
                            <li class="item-shiptime selected">
                                <input type="radio" name="Checkout[shiptime_id]" checked="checked" value="1">
                                <p>
                                    不限送货时间
                                    <span>周一至周日</span>
                                </p>
                            </li>
                            <li class="item-shiptime">
                                <input type="radio" name="Checkout[shiptime_id]" value="2">
                                <p>
                                    工作日送货
                                    <span>周一至周五</span>
                                </p>
                            </li>
                            <li class="item-shiptime">
                                <input type="radio" name="Checkout[shiptime_id]" value="3">
                                <p>
                                    双休、假日送货
                                    <span>周六至周日</span>
                                </p>
                            </li>
                        </ul>
                    </div>
                </div>
                <!-- 送货时间结束 -->
            </div>
            <div class="main-body-bottom">
                <!-- 商品清单 -->
                <div class="mbb-box">
                    <div class="mbb-box-title">
                        <h2 class="title">确认订单信息</h2>
                    </div>
                    <div class="mbb-box-body">
                        <dl class="good-list">
                            <dt class="fixWindow">
                                <span class="col col-1">商品名称</span>
                                <span class="col col-2">购买价格</span>
                                <span class="col col-3">购买数量</span>
                                <span class="col col-4">小计（元）</span>
                            </dt>
                            <!--<dd class="item fixWindow">-->
                            <!--    <div class="item-row">-->
                            <!--        <div class="col col-1">-->
                            <!--           <div class="good-pic">-->
                            <!--               <img src="../static/images/beef.jpg" alt="" width="40px" height="40px">-->
                            <!--            </div>-->
                            <!--           <div class="good-info"><a href="../templates/shopitem.html">农夫好牛 精品肥牛卷鲜嫩牛肉卷1200g</a></div>-->
                            <!--       </div>-->
                            <!--         <div class="col col-2">99.00元</div>-->
                            <!--         <div class="col col-3">1</div>-->
                            <!--        <div class="col col-4">99.00元</div>-->
                            <!--     </div>-->
                            <!--</dd>-->
                        </dl>
                        <div class="good-confirm fixWindow">
                            <div class="good-confirm-note">
                                <h3 class="title">会员留言</h3>
                                <input type="text">
                            </div>
                            <!--<div class="good-confirm-price">-->
                            <!--<ul>-->
                            <!--<li>订单总额：<span>343.90元</span></li>-->
                            <!--<li>活动优惠：<span>-0元</span></li>-->
                            <!--<li>优惠券抵扣：<span>-0元</span></li>-->
                            <!--<li>运费：<span>0元</span></li>-->
                            <!--</ul>-->
                            <!--<p class="good-confirm-total">-->
                            <!--应付总额：-->
                            <!--<span>-->
                            <!--<strong id="totalPrice">343.90</strong>-->
                            <!--元-->
                            <!--</span>-->
                            <!--</p>-->
                            <!--</div>-->
                        </div>
                    </div>
                </div>
                <!-- 商品清单结束 -->
                <!-- 下单按钮 -->
                <div class="good-confirm-btn">
                    <a href="#" class="btn btn-gray btn-back-cart">返回</a>
                    <input type="button" class="btn btn-red btn-order-now" value="立即下单" id="checkoutToPay"
                           onclick="checkoutOrder()">
                </div>
                <!-- 下单按钮结束 -->
            </div>
        </form>
    </div>
</main>
<footer>
    
</footer>

</body>
<script>
    $(function () {
        // 初始化 地址三级联动选择
        $('#addr_select').distpicker({
            province: '请选择省份/自治区',
            city: '请选择城市/地区',
            district: '请选择区/县'
        });
        var item_html = "";
        // 商品跳转详情页 "127.0.0.1:5000/item/" + id
        var item_url = "http://127.0.0.1:8000/item/";
        var total_price = 0;

        $.ajax({
            // 此地址作为测试，实际应向上一级页面发get请求
            url: 'http://127.0.0.1:5000/v1/order',
            type: 'get',
            dataType: 'json',
            beforeSend: function (request) {
                // request.setRequestHeader("Authorization", token);
            },
            success: function (res) {
                if (res.code == 200) {
                    // alert('导入商品列表');
                    var item = res.data.item
                    if (item.length == 0) {
                        alert('没有商品数据');
                    } else {
                        for (var i in item) {
                            var id = item[i].id;
                            var title = item[i].title;
                            var image = item[i].image;
                            var price = item[i].price;
                            var count = item[i].count;
                            item_html += '<dd class="item fixWindow">';
                            item_html += '<div class="item-row">';
                            item_html += '<div class="col col-1">';
                            item_html += '<div class="good-pic">';
                            item_html += '<img src="' + image + '" alt="" width="40px" height="40px">';
                            item_html += '</div>';
                            item_html += '<div class="good-info"><a href="' + item_url + id + '">' + title + '</a></div>';
                            item_html += '</div>';
                            item_html += '<div class="col col-2">' + price.toFixed(2) + '元</div>';
                            item_html += '<div class="col col-3">' + count + '</div>';
                            item_html += '<div class="col col-4">' + (price * count).toFixed(2) + '</div>';
                            item_html += '</div>';
                            item_html += '</dd>';
                            total_price += price * count;
                        }
                    }
                } else {
                    alert(res.error);
                }
                $(".good-list dt").after(item_html);
                total_price = total_price.toFixed(2);
                var total_price_html = `<div class="good-confirm-price">
                                <ul>
                                    <li>订单总额：<span>${total_price}元</span></li>
                                    <li>活动优惠：<span>0元</span></li>
                                    <li>优惠券抵扣：<span>0元</span></li>
                                    <li>运费：<span>0元</span></li>
                                </ul>
                                <p class="good-confirm-total">
                                    应付总额：
                                    <span>
                                        <strong id="totalPrice">${total_price}</strong>
                                        元
                                    </span>
                                </p>
                            </div>`;
                $(".good-confirm-note").after(total_price_html);

            }
        });
        $.fn.serializeObject = function () {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function () {
                if (o[this.name]) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };
        var $checkoutForm = $('#checkout-form');
        var formData = $checkoutForm.serializeObject();

        function checkoutOrder() {
            console.log('click checkout order button')
            console.log(formData)
            $.ajax({
                url: 'http://127.0.0.1:5000/v1/order',
                type: 'POST',
                dataType: 'json',
                data: JSON.stringify(formData),
                contentType: 'application/json',
                success: function (res) {
                    if (res.code == 200) {
                        alert('订单已生成');
                        //window.localStorage.setItem('dnblog_token',res.data.token);
                    } else {
                        alert(res.error);
                    }
                }
            });
        }
    })
</script>
</html>